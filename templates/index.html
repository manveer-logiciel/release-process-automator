<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIRA Release Card Automator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .auth-card {
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
        }
        .auth-card.authenticated {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .auth-card.not-authenticated {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        .status-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .authenticated .status-icon {
            color: #28a745;
        }
        .not-authenticated .status-icon {
            color: #dc3545;
        }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
        }
        .feature-card {
            height: 100%;
            transition: transform 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .auth-form {
            display: none;
        }
        .auth-form.show {
            display: block;
        }
        .credential-input {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-rocket me-2"></i>
                Release Card Automator
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm" onclick="clearCredentials()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Clear Credentials
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section py-3">
        <div class="container text-center">
            <h3 class="fw-bold mb-2">
                <i class="fas fa-magic me-2"></i>
                Release Card Automator
            </h3>
            <p class="mb-0 text-muted">
                Create JIRA release cards with GitHub integration
            </p>
        </div>
    </section>

    <!-- Authentication Section -->
    <section class="py-3">
        <div class="container">
            <div class="row justify-content-center mb-3">
                <div class="col-auto">
                    <h6 class="text-muted mb-0">
                        <i class="fas fa-shield-alt me-1"></i>
                        Auth Status
                    </h6>
                </div>
            </div>
            
            <div class="row g-2 justify-content-center">
                <!-- JIRA Authentication -->
                <div class="col-auto">
                    <div class="card auth-card p-2" id="jiraCard" style="min-width: 200px;">
                        <div class="card-body text-center p-2">
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="fas fa-times-circle status-icon me-2" id="jiraIcon"></i>
                                <div class="text-start">
                                    <h6 class="mb-0">
                                        <i class="fab fa-atlassian me-1"></i>
                                        JIRA
                                    </h6>
                                    <div id="jiraStatus">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Not connected
                                        </small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-primary ms-2" onclick="showJiraForm()">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                            
                            <!-- JIRA Authentication Form -->
                            <div class="auth-form" id="jiraForm">
                                <div class="text-start">
                                    <div class="credential-input">
                                        <label class="form-label">JIRA Domain</label>
                                        <input type="text" class="form-control" id="jiraDomain" value="leap.atlassian.net" placeholder="leap.atlassian.net">
                                        <small class="form-text text-muted">Your JIRA instance URL (without https://)</small>
                                    </div>
                                    <div class="credential-input">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="jiraEmail" placeholder="your-email@company.com">
                                    </div>
                                    <div class="credential-input">
                                        <label class="form-label">API Token</label>
                                        <input type="password" class="form-control" id="jiraToken" placeholder="Your JIRA API Token">
                                        <small class="form-text text-muted">
                                            <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Create API Token</a>
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" onclick="saveJiraCredentials()">
                                            <i class="fas fa-save me-1"></i>
                                            Save & Test
                                        </button>
                                        <button class="btn btn-secondary" onclick="hideJiraForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GitHub Authentication -->
                <div class="col-auto">
                    <div class="card auth-card p-2" id="githubCard" style="min-width: 200px;">
                        <div class="card-body text-center p-2">
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="fas fa-times-circle status-icon me-2" id="githubIcon"></i>
                                <div class="text-start">
                                    <h6 class="mb-0">
                                        <i class="fab fa-github me-1"></i>
                                        GitHub
                                    </h6>
                                    <div id="githubStatus">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Not connected
                                        </small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-dark ms-2" onclick="showGithubForm()">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                            
                            <!-- GitHub Authentication Form -->
                            <div class="auth-form" id="githubForm">
                                <div class="text-start">
                                    <div class="credential-input">
                                        <label class="form-label">Personal Access Token</label>
                                        <input type="password" class="form-control" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                        <small class="form-text text-muted">
                                            <a href="https://github.com/settings/tokens" target="_blank">Create Personal Access Token</a>
                                            <br>Required scopes: repo, read:user
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" onclick="saveGithubCredentials()">
                                            <i class="fas fa-save me-1"></i>
                                            Save & Test
                                        </button>
                                        <button class="btn btn-secondary" onclick="hideGithubForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Action Section -->
    <section class="py-5 bg-light" id="actionSection" style="display: none;">
        <div class="container text-center">
            <h2 class="mb-4">
                <i class="fas fa-plus-circle me-2"></i>
                Ready to Create Cards
            </h2>
            <p class="lead mb-4">You're all set! Start creating JIRA cards for your release process.</p>
            <button class="btn btn-success btn-lg" onclick="showCreateCardForm()">
                <i class="fas fa-plus me-2"></i>
                Create JIRA Card
            </button>
        </div>
    </section>

    <!-- Create Card Form -->
    <section class="py-5" id="createCardSection" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>
                                Create JIRA Release Card
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="createCardForm">
                                <!-- Release Type Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Release Type</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="releaseType" id="plannedRelease" value="planned" autocomplete="off" required>
                                            <label class="btn btn-outline-primary w-100" for="plannedRelease">
                                                <i class="fas fa-calendar-alt me-2"></i>
                                                Planned Release
                                            </label>
                                        </div>
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="releaseType" id="hotfixRelease" value="hotfix" autocomplete="off" required>
                                            <label class="btn btn-outline-danger w-100" for="hotfixRelease">
                                                <i class="fas fa-fire me-2"></i>
                                                Hotfix Release
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Deployment Type Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Deployment Type</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="deploymentType" id="webApi" value="web-api" autocomplete="off" required>
                                            <label class="btn btn-outline-info w-100" for="webApi">
                                                <i class="fas fa-globe me-2"></i>
                                                Web & API
                                            </label>
                                        </div>
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="deploymentType" id="webOnly" value="web-only" autocomplete="off" required>
                                            <label class="btn btn-outline-success w-100" for="webOnly">
                                                <i class="fas fa-desktop me-2"></i>
                                                Web Only
                                            </label>
                                        </div>
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="deploymentType" id="apiOnly" value="api-only" autocomplete="off" required>
                                            <label class="btn btn-outline-warning w-100" for="apiOnly">
                                                <i class="fas fa-code me-2"></i>
                                                API Only
                                            </label>
                                        </div>
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="deploymentType" id="publicApi" value="public-api" autocomplete="off" required>
                                            <label class="btn btn-outline-purple w-100" for="publicApi">
                                                <i class="fas fa-share-alt me-2"></i>
                                                Public API
                                            </label>
                                        </div>
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="deploymentType" id="mobile" value="mobile" autocomplete="off" required>
                                            <label class="btn btn-outline-secondary w-100" for="mobile">
                                                <i class="fas fa-mobile-alt me-2"></i>
                                                Mobile
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- GitHub Repository (Auto-detected) -->
                                <div class="mb-3">
                                    <label class="form-label">GitHub Repository</label>
                                    <div id="singleRepoSection">
                                        <input type="text" class="form-control" id="githubRepo" placeholder="Will be auto-detected" readonly>
                                    </div>
                                    <div id="multiRepoSection" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label small">React App Repository</label>
                                                <input type="text" class="form-control" id="reactRepo" value="JobProgress-Org/jp_app_main_v2" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">Angular App Repository</label>
                                                <input type="text" class="form-control" id="angularRepo" value="JobProgress-Org/jp_app_main" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">Repository and versions are automatically detected based on project selection</small>
                                </div>

                                <!-- Version Display -->
                                <div class="mb-3" id="versionSection" style="display: none;">
                                    <!-- Single Version (for Web Only, API Only, Mobile) -->
                                    <div id="singleVersionSection">
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label">Current Version</label>
                                                <input type="text" class="form-control" id="currentVersion" readonly>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">New Version</label>
                                                <input type="text" class="form-control" id="newVersion" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dual Version (for Web & API) -->
                                    <div id="dualVersionSection" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <h6 class="mb-2"><i class="fas fa-desktop me-1"></i> Web Version</h6>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Current Web</label>
                                                <input type="text" class="form-control" id="currentWebVersion" readonly>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">New Web</label>
                                                <input type="text" class="form-control" id="newWebVersion" readonly>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <h6 class="mb-2"><i class="fas fa-code me-1"></i> API Version</h6>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Current API</label>
                                                <input type="text" class="form-control" id="currentApiVersion" readonly>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">New API</label>
                                                <input type="text" class="form-control" id="newApiVersion" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Auto-generated Title -->
                                <div class="mb-3">
                                    <label class="form-label">Release Title</label>
                                    <input type="text" class="form-control" id="releaseTitle" placeholder="Will be auto-generated" readonly>
                                    <small class="form-text text-muted">Title will be generated based on your selections</small>
                                </div>

                                <!-- Project Key -->
                                <div class="mb-3">
                                    <label class="form-label">Project Key</label>
                                    <select class="form-select" id="projectKey" required>
                                        <option value="LEAP" selected>LEAP</option>
                                        <option value="PAY">PAY</option>
                                    </select>
                                </div>

                                <!-- Issue Type -->
                                <div class="mb-3">
                                    <label class="form-label">Issue Type</label>
                                    <select class="form-select" id="issueType" required>
                                        <option value="Production Change" selected>Production Change</option>
                                        <option value="Task">Task</option>
                                    </select>
                                </div>

                                <!-- Release Date -->
                                <div class="mb-3">
                                    <label class="form-label">Release Date</label>
                                    <input type="date" class="form-control" id="releaseDate" required>
                                    <small class="form-text text-muted">This will be set as the due date in JIRA</small>
                                </div>

                                <!-- Description -->
                                <div class="mb-3">
                                    <label class="form-label">Description (Optional)</label>
                                    <textarea class="form-control" id="description" rows="3" placeholder="Additional release notes or details"></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-plus-circle me-2"></i>
                                    Create Release Card
                                </button>
                                
                                <!-- Debug test button -->
                                <button type="button" class="btn btn-warning btn-sm mt-2 w-100" onclick="testApiConnection()">
                                    <i class="fas fa-bug me-1"></i>
                                    Test API Connection
                                </button>
                                
                                <button type="button" class="btn btn-secondary mt-2" onclick="hideCreateCardForm()">
                                    Cancel
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">
                <i class="fas fa-star me-2"></i>
                Features
            </h2>
            
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card feature-card border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-key text-primary" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h5 class="card-title">Simple Authentication</h5>
                            <p class="card-text">Easy setup with email/API tokens for JIRA and personal access tokens for GitHub</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card feature-card border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-rocket text-success" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h5 class="card-title">Quick Creation</h5>
                            <p class="card-text">Create JIRA cards instantly with pre-configured templates and smart defaults</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card feature-card border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-sync text-info" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h5 class="card-title">Multi-Project</h5>
                            <p class="card-text">Support for multiple JIRA projects with dynamic issue type detection</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">
                <i class="fas fa-code me-1"></i>
                Release Card Automator - Streamline Your Workflow
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        function checkAuthStatus() {
            const jiraAuth = localStorage.getItem('jira_auth');
            const githubAuth = localStorage.getItem('github_auth');
            
            if (jiraAuth) {
                const jiraData = JSON.parse(jiraAuth);
                updateJiraStatus(true, jiraData.domain);
            }
            
            if (githubAuth) {
                updateGithubStatus(true);
            }
            
            // Show action section if JIRA is authenticated
            if (jiraAuth) {
                document.getElementById('actionSection').style.display = 'block';
            }
            
            // Show logout button if any service is authenticated
            if (jiraAuth || githubAuth) {
                document.getElementById('logoutBtn').style.display = 'block';
            }
        }

        function showJiraForm() {
            document.getElementById('jiraStatus').style.display = 'none';
            document.getElementById('jiraForm').classList.add('show');
        }

        function hideJiraForm() {
            document.getElementById('jiraStatus').style.display = 'block';
            document.getElementById('jiraForm').classList.remove('show');
        }

        function showGithubForm() {
            document.getElementById('githubStatus').style.display = 'none';
            document.getElementById('githubForm').classList.add('show');
        }

        function hideGithubForm() {
            document.getElementById('githubStatus').style.display = 'block';
            document.getElementById('githubForm').classList.remove('show');
        }

        async function saveJiraCredentials() {
            const domain = document.getElementById('jiraDomain').value;
            const email = document.getElementById('jiraEmail').value;
            const token = document.getElementById('jiraToken').value;
            
            if (!domain || !email || !token) {
                alert('Please fill in all JIRA fields');
                return;
            }
            
            // Test JIRA connection via server proxy
            try {
                const response = await fetch('/api/jira/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        email: email,
                        token: token
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Save credentials
                    localStorage.setItem('jira_auth', JSON.stringify({
                        domain: domain,
                        email: email,
                        token: token
                    }));
                    
                    updateJiraStatus(true, domain);
                    hideJiraForm();
                    document.getElementById('actionSection').style.display = 'block';
                    document.getElementById('logoutBtn').style.display = 'block';
                    
                    // Clear form
                    document.getElementById('jiraDomain').value = 'leap.atlassian.net';
                    document.getElementById('jiraEmail').value = '';
                    document.getElementById('jiraToken').value = '';
                } else {
                    alert('JIRA authentication failed: ' + (result.error || 'Please check your credentials.'));
                }
            } catch (error) {
                alert('Error connecting to JIRA: ' + error.message);
            }
        }

        async function saveGithubCredentials() {
            const token = document.getElementById('githubToken').value;
            
            if (!token) {
                alert('Please enter your GitHub token');
                return;
            }
            
            // Test GitHub connection via server proxy
            try {
                const response = await fetch('/api/github/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Save credentials
                    localStorage.setItem('github_auth', JSON.stringify({
                        token: token
                    }));
                    
                    updateGithubStatus(true);
                    hideGithubForm();
                    document.getElementById('logoutBtn').style.display = 'block';
                    
                    // Clear form
                    document.getElementById('githubToken').value = '';
                } else {
                    alert('GitHub authentication failed: ' + (result.error || 'Please check your token.'));
                }
            } catch (error) {
                alert('Error connecting to GitHub: ' + error.message);
            }
        }

        function updateJiraStatus(authenticated, domain = '') {
            const card = document.getElementById('jiraCard');
            const icon = document.getElementById('jiraIcon');
            const status = document.getElementById('jiraStatus');
            
            if (authenticated) {
                card.classList.remove('not-authenticated');
                card.classList.add('authenticated');
                icon.classList.remove('fa-times-circle');
                icon.classList.add('fa-check-circle');
                status.innerHTML = `
                    <p class="card-text text-success">
                        <i class="fas fa-check me-1"></i>
                        Connected to ${domain}
                    </p>
                    <p class="text-muted small">You can now create JIRA cards</p>
                `;
            } else {
                card.classList.remove('authenticated');
                card.classList.add('not-authenticated');
                icon.classList.remove('fa-check-circle');
                icon.classList.add('fa-times-circle');
            }
        }

        function updateGithubStatus(authenticated) {
            const card = document.getElementById('githubCard');
            const icon = document.getElementById('githubIcon');
            const status = document.getElementById('githubStatus');
            
            if (authenticated) {
                card.classList.remove('not-authenticated');
                card.classList.add('authenticated');
                icon.classList.remove('fa-times-circle');
                icon.classList.add('fa-check-circle');
                status.innerHTML = `
                    <p class="card-text text-success">
                        <i class="fas fa-check me-1"></i>
                        Successfully authenticated with GitHub
                    </p>
                    <p class="text-muted small">Repository integration available</p>
                `;
            } else {
                card.classList.remove('authenticated');
                card.classList.add('not-authenticated');
                icon.classList.remove('fa-check-circle');
                icon.classList.add('fa-times-circle');
            }
        }

        function clearCredentials() {
            localStorage.removeItem('jira_auth');
            localStorage.removeItem('github_auth');
            location.reload();
        }

        function showCreateCardForm() {
            document.getElementById('createCardSection').style.display = 'block';
            document.getElementById('createCardSection').scrollIntoView({ behavior: 'smooth' });
        }

        function hideCreateCardForm() {
            document.getElementById('createCardSection').style.display = 'none';
        }

        // Version increment logic
        function incrementVersion(version, releaseType) {
            const parts = version.split('.').map(Number);
            if (parts.length !== 3) return version; // Invalid version format
            
            if (releaseType === 'hotfix') {
                // Increment patch version (last number)
                parts[2] += 1;
            } else if (releaseType === 'planned') {
                // Increment minor version (middle number), reset patch to 0
                parts[1] += 1;
                parts[2] = 0;
            }
            
            return parts.join('.');
        }

        // Generate release title based on selections
        function generateReleaseTitle(releaseType, version, isHotfix = false) {
            const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
            
            if (!deploymentType) return '';
            
            const hotfixSuffix = isHotfix ? ' (Hotfix)' : '';
            
            const titleMap = {
                'web-only': `LEAP CRM Web ${version} Release${hotfixSuffix}`,
                'api-only': `LEAP CRM API ${version} Release${hotfixSuffix}`,
                'public-api': `Leap CRM L5 Public API Release ${version}${hotfixSuffix}`,
                'mobile': `LEAP CRM Mobile Release ${version}${hotfixSuffix}`
            };
            
            const title = titleMap[deploymentType] || `LEAP CRM Release ${version}${hotfixSuffix}`;
            document.getElementById('releaseTitle').value = title;
            return title;
        }
        
        function updateReleaseTitle() {
            const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
            const releaseTypeEl = document.querySelector('input[name="releaseType"]:checked');
            
            if (!deploymentType || !releaseTypeEl) return;
            
            const isHotfix = releaseTypeEl.value === 'hotfix';
            const hotfixSuffix = isHotfix ? ' (Hotfix)' : '';
            
            if (deploymentType === 'web-api') {
                const webVersion = document.getElementById('newWebVersion').value;
                const apiVersion = document.getElementById('newApiVersion').value;
                if (webVersion && apiVersion) {
                    // Create custom title for Web & API with separate versions
                    const title = `LEAP CRM Web ${webVersion} and API ${apiVersion} Release${hotfixSuffix}`;
                    document.getElementById('releaseTitle').value = title;
                }
            } else {
                const version = document.getElementById('newVersion').value;
                if (version) {
                    generateReleaseTitle(deploymentType, version, isHotfix);
                }
            }
        }
        
        function compareVersions(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            
            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const part1 = parts1[i] || 0;
                const part2 = parts2[i] || 0;
                
                if (part1 > part2) return 1;
                if (part1 < part2) return -1;
            }
            return 0;
        }

        // Fetch version from GitHub
        async function fetchVersionFromGitHub() {
            const githubAuth = localStorage.getItem('github_auth');
            const projectKey = document.getElementById('projectKey').value;
            const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
            const releaseType = document.querySelector('input[name="releaseType"]:checked')?.value;
            
            if (!githubAuth) {
                alert('Please authenticate with GitHub first');
                return;
            }
            
            if (!projectKey) {
                alert('Please select a project first');
                return;
            }
            
            const token = JSON.parse(githubAuth).token;
            const projectRepos = projectRepoMapping[projectKey];
            
            try {
                if (deploymentType === 'web-api') {
                    // Fetch both web and API versions
                    const [webResponse, apiResponse] = await Promise.all([
                        fetch('/api/github/version', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token, repo: projectRepos.web })
                        }),
                        fetch('/api/github/version', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token, repo: projectRepos.api })
                        })
                    ]);
                    
                    const webResult = await webResponse.json();
                    const apiResult = await apiResponse.json();
                    
                    const detailsResponse = await fetch('/change_templates/web_production_change_detail.md');
                    const rollbackResponse = await fetch('/change_templates/web_production_rollback_script.md');
                    
                    if (webResponse.ok && apiResponse.ok && webResult.success && apiResult.success) {
                        // Set current versions
                        document.getElementById('currentWebVersion').value = webResult.version;
                        document.getElementById('currentApiVersion').value = apiResult.version;
                        
                        // Calculate new versions
                        if (releaseType) {
                            const newWebVersion = incrementVersion(webResult.version, releaseType);
                            const newApiVersion = incrementVersion(apiResult.version, releaseType);
                            document.getElementById('newWebVersion').value = newWebVersion;
                            document.getElementById('newApiVersion').value = newApiVersion;
                        }
                        
                        // Show dual version section
                        document.getElementById('singleVersionSection').style.display = 'none';
                        document.getElementById('dualVersionSection').style.display = 'block';
                        document.getElementById('versionSection').style.display = 'block';
                        
                        // Generate title with versions
                        setTimeout(() => updateReleaseTitle(), 100);
                    } else {
                        alert('Error fetching versions: ' + (webResult.error || apiResult.error || 'Unknown error'));
                    }
                } else {
                    // Single repository for web-only, api-only, public-api, or mobile
                    let repo;
                    if (deploymentType === 'web-only') {
                        repo = projectRepos.web;
                    } else if (deploymentType === 'api-only') {
                        repo = projectRepos.api;
                    } else if (deploymentType === 'public-api') {
                        repo = projectRepos.publicApi;
                    } else if (deploymentType === 'mobile') {
                        repo = projectRepos.mobile;
                    }
                    
                    const response = await fetch('/api/github/version', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, repo: repo })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        document.getElementById('currentVersion').value = result.version;
                        
                        if (releaseType) {
                            const newVersion = incrementVersion(result.version, releaseType);
                            document.getElementById('newVersion').value = newVersion;
                        }
                        
                        // Show single version section
                        document.getElementById('dualVersionSection').style.display = 'none';
                        document.getElementById('singleVersionSection').style.display = 'block';
                        document.getElementById('versionSection').style.display = 'block';
                        
                        // Generate title with version
                        setTimeout(() => updateReleaseTitle(), 100);
                    } else {
                        alert('Error fetching version: ' + (result.error || 'Unknown error'));
                    }
                }
            } catch (error) {
                alert('Error fetching version: ' + error.message);
            }
        }

        // Project to repository mapping
        const projectRepoMapping = {
            'LEAP': {
                web: 'JobProgress-Org/jp_app_main_v2',
                api: 'JobProgress-Org/jp_api_main',
                publicApi: 'JobProgress-Org/jp_api_main_v2',
                mobile: 'JobProgress-Org/jp_mobile_main_v2'
            },
            'PAY': {
                web: 'JobProgress-Org/jp_app_main_v2',
                api: 'JobProgress-Org/jp_api_main',
                publicApi: 'JobProgress-Org/jp_api_main_v2',
                mobile: 'JobProgress-Org/jp_mobile_main_v2'
            }
        };

        // Auto-detect repository based on project selection
        function detectRepository() {
            const projectKey = document.getElementById('projectKey').value;
            const projectRepos = projectRepoMapping[projectKey];
            
            if (projectRepos) {
                const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
                
                if (deploymentType === 'web-only' || deploymentType === 'web-api') {
                    // Show both repositories for web deployments
                    document.getElementById('singleRepoSection').style.display = 'none';
                    document.getElementById('multiRepoSection').style.display = 'block';
                } else {
                    // Show single repository for other deployment types
                    document.getElementById('singleRepoSection').style.display = 'block';
                    document.getElementById('multiRepoSection').style.display = 'none';
                    
                    if (deploymentType === 'api-only') {
                        document.getElementById('githubRepo').value = projectRepos.api;
                    } else if (deploymentType === 'mobile') {
                        document.getElementById('githubRepo').value = projectRepos.mobile;
                    } else {
                        // Default to web if no deployment type selected
                        document.getElementById('githubRepo').value = projectRepos.web;
                    }
                    
                    // Enable fetch button if GitHub is authenticated
                    const githubAuth = localStorage.getItem('github_auth');
                    if (githubAuth) {
                        document.getElementById('fetchVersionBtn').disabled = false;
                    }
                }
            } else {
                document.getElementById('githubRepo').value = '';
                document.getElementById('fetchVersionBtn').disabled = true;
                document.getElementById('versionSection').style.display = 'none';
            }
        }

        // Auto-fetch versions when both release type and deployment type are selected
        function autoFetchVersions() {
            const releaseType = document.querySelector('input[name="releaseType"]:checked')?.value;
            const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
            
            // Only auto-fetch if both selections are made
            if (releaseType && deploymentType) {
                fetchVersionFromGitHub();
            }
        }

        // Add event listeners for form changes
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for project selection changes
            document.getElementById('projectKey').addEventListener('change', detectRepository);
            
            // Listen for release type changes
            document.querySelectorAll('input[name="releaseType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
                    updateReleaseTitle(); // Update title
                    autoFetchVersions(); // Auto-fetch versions when both selections are made
                    
                    if (deploymentType === 'web-api') {
                        // Handle dual version scenario
                        const currentWebVersion = document.getElementById('currentWebVersion').value;
                        const currentApiVersion = document.getElementById('currentApiVersion').value;
                        
                        if (currentWebVersion && currentApiVersion) {
                            const newWebVersion = incrementVersion(currentWebVersion, this.value);
                            const newApiVersion = incrementVersion(currentApiVersion, this.value);
                            document.getElementById('newWebVersion').value = newWebVersion;
                            document.getElementById('newApiVersion').value = newApiVersion;
                            updateReleaseTitle();
                        } else {
                            // Auto-fetch if repository is already detected
                            const repo = document.getElementById('githubRepo').value;
                            if (repo && repo !== 'Will be auto-detected') {
                                fetchVersionFromGitHub();
                            }
                        }
                    } else {
                        // Handle single version scenario
                        const currentVersion = document.getElementById('currentVersion').value;
                        if (currentVersion) {
                            const newVersion = incrementVersion(currentVersion, this.value);
                            document.getElementById('newVersion').value = newVersion;
                            updateReleaseTitle();
                        } else {
                            // Auto-fetch if repository is already detected
                            const repo = document.getElementById('githubRepo').value;
                            if (repo && repo !== 'Will be auto-detected') {
                                fetchVersionFromGitHub();
                            }
                        }
                    }
                });
            });
            
            // Listen for deployment type changes
            document.querySelectorAll('input[name="deploymentType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    detectRepository(); // Update repository display
                    updateReleaseTitle(); // Update title
                    autoFetchVersions(); // Auto-fetch versions when both selections are made
                });
            });
        });

        document.getElementById('createCardForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submission started');
            
            const jiraAuth = localStorage.getItem('jira_auth');
            if (!jiraAuth) {
                alert('Please authenticate with JIRA first');
                return;
            }
            console.log('JIRA auth found:', jiraAuth);
            
            // Show loading indicator
            const submitButton = document.querySelector('#createCardForm button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Release Card...';
            submitButton.disabled = true;
            console.log('Loading indicator shown');
            
            // Add timeout to reset button if stuck
            const timeoutId = setTimeout(() => {
                console.error('Form submission timed out after 30 seconds');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
                alert('Form submission timed out. Please check the console for errors.');
            }, 30000);
            
            // Clear any previous results
            const existingResults = document.querySelectorAll('.alert');
            existingResults.forEach(alert => alert.remove());
            
            const projectKey = document.getElementById('projectKey')?.value || '';
            const summary = document.getElementById('releaseTitle')?.value || '';
            const issueType = document.getElementById('issueType')?.value || '';
            const releaseDate = document.getElementById('releaseDate')?.value || '';
            const jiraKey = document.getElementById('jiraKey')?.value || '';
            const deploymentType = document.querySelector('input[name="deploymentType"]:checked')?.value;
            
            console.log('Form data:', { projectKey, summary, issueType, releaseDate, jiraKey, deploymentType });
            
            // Validate required fields
            if (!projectKey || !summary || !issueType || !deploymentType) {
                alert('Please fill in all required fields');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
                return;
            }
            
            let processedDetails = '';
            let processedRollback = '';
            
            if (deploymentType === 'web-only' || deploymentType === 'web-api') {
                // Get version for template processing
                const version = deploymentType === 'web-api' ? 
                    document.getElementById('newWebVersion').value : 
                    document.getElementById('newVersion').value;
                
                console.log('Version for template processing:', version);
                
                if (!version) {
                    alert('Version not found. Please ensure versions are fetched before creating the release card.');
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                    return;
                }
                
                const versionParts = version.split('.');
                const firstTwoDigits = versionParts.slice(0, 2).join('.');
                const lastDigit = versionParts[2] || '0';
                
                // Read and process templates from .md files
                try {
                    console.log('Loading template files...');
                    const detailsResponse = await fetch('/change_templates/web_production_change_detail.md');
                    const rollbackResponse = await fetch('/change_templates/web_production_rollback_script.md');
                    
                    console.log('Template responses:', detailsResponse.status, rollbackResponse.status);
                    
                    if (detailsResponse.ok && rollbackResponse.ok) {
                        let detailsTemplate = await detailsResponse.text();
                        let rollbackTemplate = await rollbackResponse.text();
                        
                        console.log('Templates loaded successfully');
                        
                        // Process placeholders in templates
                        processedDetails = detailsTemplate
                            .replace(/\[JIRA-KEY\]/g, jiraKey)
                            .replace(/\[NEW_VERSION\]/g, version)
                            .replace(/\[NEW_VERSION_FIRST_2_DIGITS\]/g, firstTwoDigits)
                            .replace(/\[NEW_VERSION_LAST_DIGIT\]/g, lastDigit);
                        
                        processedRollback = rollbackTemplate
                            .replace(/\[VERSION\]/g, version);
                            
                        console.log('Templates processed successfully');
                    } else {
                        console.error('Failed to load template files:', detailsResponse.status, rollbackResponse.status);
                        alert('Failed to load template files. Please check if the template files exist.');
                        submitButton.innerHTML = originalButtonText;
                        submitButton.disabled = false;
                        return;
                    }
                } catch (error) {
                    console.error('Error loading templates:', error);
                    alert('Error loading templates: ' + error.message);
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                    return;
                }
            }

            const issueData = {
                fields: {
                    project: {
                        key: projectKey
                    },
                    summary: summary,
                    issuetype: {
                        name: issueType
                    },
                    duedate: releaseDate
                },
                processedDetails,
                processedRollback,
                deploymentType
            };
            
            console.log('Sending request to create JIRA issue:', issueData);
            
            let parsedJiraAuth;
            try {
                parsedJiraAuth = JSON.parse(jiraAuth);
                console.log('Parsed JIRA auth successfully');
            } catch (parseError) {
                console.error('Failed to parse JIRA auth:', parseError);
                alert('Invalid JIRA authentication data. Please re-authenticate.');
                return;
            }
            
            const requestBody = {
                domain: parsedJiraAuth.domain,
                email: parsedJiraAuth.email,
                token: parsedJiraAuth.token,
                issue_data: issueData
            };
            console.log('Request body prepared:', requestBody);
            
            try {
                console.log('Making fetch request...');
                const response = await fetch('/api/jira/create-issue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (response.ok && result.success) {
                    // Update templates with actual JIRA key
                    const actualJiraKey = result.key;
                    
                    // Create GitHub branches if this is a web deployment
                    if (issueData.deploymentType === 'web-only' || issueData.deploymentType === 'web-api') {
                        await createGitHubBranches(actualJiraKey, issueData);
                    }
                    
                    // Update JIRA card with processed templates
                    if (issueData.processedDetails || issueData.processedRollback) {
                        console.log('Updating JIRA card with templates:', {
                            processedDetails: issueData.processedDetails,
                            processedRollback: issueData.processedRollback
                        });
                        await updateJiraCardWithTemplates(actualJiraKey, issueData, parsedJiraAuth);
                    }
                    
                    // Create success message with clickable URL
                    const successDiv = document.createElement('div');
                    successDiv.className = 'alert alert-success mt-3';
                    successDiv.innerHTML = `
                        <h5><i class="fas fa-check-circle me-2"></i>JIRA Card Created Successfully!</h5>
                        <p><strong>Key:</strong> ${result.key}</p>
                        <p><strong>URL:</strong> <a href="${result.url}" target="_blank" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-external-link-alt me-1"></i>Open JIRA Ticket
                        </a></p>
                        <div class="mt-2">
                            <small class="text-muted">${result.url}</small>
                        </div>
                        ${(issueData.deploymentType === 'web-only' || issueData.deploymentType === 'web-api') ? 
                            '<p class="mt-2"><small class="text-success"><i class="fas fa-check me-1"></i>GitHub branches and templates have been processed</small></p>' : ''}
                        <div class="mt-3 d-flex gap-2">
                            <button type="button" class="btn btn-danger btn-sm" onclick="revertRelease('${result.key}', '${issueData.deploymentType}', '${issueData.version}')">
                                <i class="fas fa-undo me-1"></i>Revert All Changes
                            </button>
                            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                        </div>
                    `;
                    
                    document.getElementById('createCardForm').appendChild(successDiv);
                    
                    // Auto-remove success message after 15 seconds
                    setTimeout(() => {
                        if (successDiv.parentElement) {
                            successDiv.remove();
                        }
                    }, 15000);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger mt-3';
                    errorDiv.innerHTML = `
                        <h5><i class="fas fa-exclamation-circle me-2"></i>Error Creating JIRA Card</h5>
                        <p>${JSON.stringify(result.error || 'Unknown error')}</p>
                        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                    `;
                    document.getElementById('createCardForm').appendChild(errorDiv);
                }
            } catch (error) {
                console.error('Full error details:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = `
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Error Creating JIRA Card</h5>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Stack:</strong> <small>${error.stack || 'No stack trace available'}</small></p>
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                `;
                document.getElementById('createCardForm').appendChild(errorDiv);
            } finally {
                // Clear timeout and reset button state
                clearTimeout(timeoutId);
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            }
        });

        // Revert release - delete JIRA card and GitHub branches
        async function revertRelease(jiraKey, deploymentType, version) {
            if (!confirm(`Are you sure you want to revert all changes for ${jiraKey}?\n\nThis will:\n- Delete the JIRA card\n- Delete GitHub branches (if created)\n\nThis action cannot be undone!`)) {
                return;
            }

            const revertBtn = event.target;
            const originalText = revertBtn.innerHTML;
            revertBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Reverting...';
            revertBtn.disabled = true;

            try {
                const jiraAuth = localStorage.getItem('jira_auth');
                const githubAuth = localStorage.getItem('github_auth');

                if (!jiraAuth) {
                    alert('JIRA authentication not found. Please re-authenticate.');
                    return;
                }

                let parsedJiraAuth;
                try {
                    parsedJiraAuth = JSON.parse(jiraAuth);
                } catch (parseError) {
                    console.error('Failed to parse JIRA auth:', parseError);
                    alert('Invalid JIRA authentication data. Please re-authenticate.');
                    return;
                }

                // Delete JIRA card
                const jiraResponse = await fetch('/api/jira/delete-issue', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: parsedJiraAuth.domain,
                        email: parsedJiraAuth.email,
                        token: parsedJiraAuth.token,
                        issueKey: jiraKey
                    })
                });

                const jiraResult = await jiraResponse.json();

                // Delete GitHub branches if applicable
                let githubResult = { success: true };
                if ((deploymentType === 'web-only' || deploymentType === 'web-api') && githubAuth) {
                    try {
                        const parsedGithubAuth = JSON.parse(githubAuth);
                        const githubResponse = await fetch('/api/github/delete-branches', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                token: parsedGithubAuth.token,
                                version: version,
                                deploymentType: deploymentType
                            })
                        });
                        githubResult = await githubResponse.json();
                    } catch (githubError) {
                        console.error('GitHub deletion error:', githubError);
                        githubResult = { success: false, error: 'Failed to delete GitHub branches' };
                    }
                }

                if (jiraResult.success && githubResult.success) {
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'alert alert-success mt-3';
                    successDiv.innerHTML = `
                        <h5><i class="fas fa-check-circle me-2"></i>Revert Completed Successfully!</h5>
                        <p><strong>JIRA Card:</strong> ${jiraKey} has been deleted</p>
                        ${(deploymentType === 'web-only' || deploymentType === 'web-api') ? 
                            '<p><strong>GitHub Branches:</strong> Release branches have been deleted</p>' : ''}
                        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                    `;
                    
                    // Remove the original success message
                    revertBtn.closest('.alert').remove();
                    
                    // Add new success message
                    document.getElementById('createCardForm').appendChild(successDiv);
                    
                    // Auto-remove success message after 10 seconds
                    setTimeout(() => {
                        if (successDiv.parentElement) {
                            successDiv.remove();
                        }
                    }, 10000);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger mt-3';
                    errorDiv.innerHTML = `
                        <h5><i class="fas fa-exclamation-circle me-2"></i>Revert Failed</h5>
                        <p><strong>JIRA:</strong> ${jiraResult.success ? 'Deleted successfully' : (jiraResult.error || 'Failed to delete')}</p>
                        <p><strong>GitHub:</strong> ${githubResult.success ? 'Deleted successfully' : (githubResult.error || 'Failed to delete branches')}</p>
                        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                    `;
                    document.getElementById('createCardForm').appendChild(errorDiv);
                }
            } catch (error) {
                console.error('Revert error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = `
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Revert Error</h5>
                    <p>Failed to revert changes: ${error.message}</p>
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                `;
                document.getElementById('createCardForm').appendChild(errorDiv);
            } finally {
                revertBtn.innerHTML = originalText;
                revertBtn.disabled = false;
            }
        }

        // Test API connection function
        async function testApiConnection() {
            console.log('Testing API connection...');
            try {
                const response = await fetch('/api/test');
                const result = await response.json();
                console.log('API test result:', result);
                alert(`API Test: ${result.status} - ${result.message}`);
            } catch (error) {
                console.error('API test failed:', error);
                alert(`API Test Failed: ${error.message}`);
            }
        }

        // Create GitHub branches
        async function createGitHubBranches(jiraKey, issueData) {
            const githubAuth = localStorage.getItem('github_auth');
            if (!githubAuth) return;
            
            const token = JSON.parse(githubAuth).token;
            const version = issueData.deploymentType === 'web-api' ? 
                document.getElementById('newWebVersion').value : 
                document.getElementById('newVersion').value;
            const branchName = `rc-${jiraKey}-${version}`;
            
            const repos = ['JobProgress-Org/jp_app_main_v2', 'JobProgress-Org/jp_app_main'];
            
            for (const repo of repos) {
                try {
                    const response = await fetch('/api/github/create-branch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token: token,
                            repo: repo,
                            branch_name: branchName,
                            base_branch: 'main'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`Created branch ${branchName} in ${repo}: ${result.url}`);
                    } else {
                        const error = await response.json();
                        console.error(`Error creating branch in ${repo}:`, error);
                    }
                } catch (error) {
                    console.error(`Error creating branch in ${repo}:`, error);
                }
            }
        }

        // Update JIRA card with processed templates
        async function updateJiraCardWithTemplates(jiraKey, issueData, jiraAuth) {
            try {
                // Update processed templates with actual JIRA key
                const updatedDetails = issueData.processedDetails.replace(/TBD/g, jiraKey);
                
                // Try to update custom fields for Production Change Details and Rollback Script
                const response = await fetch('/api/jira/update-custom-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: jiraAuth.domain,
                        email: jiraAuth.email,
                        token: jiraAuth.token,
                        issue_key: jiraKey,
                        production_details: updatedDetails,
                        rollback_script: issueData.processedRollback
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Successfully updated custom fields:', result);
                } else {
                    const error = await response.json();
                    console.error('Error updating custom fields:', error);
                    
                    // Fallback to comments if custom fields don't work
                    if (updatedDetails) {
                        await fetch('/api/jira/add-comment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                domain: jiraAuth.domain,
                                email: jiraAuth.email,
                                token: jiraAuth.token,
                                issue_key: jiraKey,
                                comment_body: `Production Change Details:\n\n${updatedDetails}`
                            })
                        });
                    }
                    
                    if (issueData.processedRollback) {
                        await fetch('/api/jira/add-comment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                domain: jiraAuth.domain,
                                email: jiraAuth.email,
                                token: jiraAuth.token,
                                issue_key: jiraKey,
                                comment_body: `Production Change Rollback Script:\n\n${issueData.processedRollback}`
                            })
                        });
                    }
                }
            } catch (error) {
                console.error('Error updating JIRA card with templates:', error);
            }
        }
    </script>
</body>
</html>
